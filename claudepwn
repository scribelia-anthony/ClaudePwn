#!/usr/bin/env bash
set -euo pipefail

CLAUDEPWN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BOXES_DIR="${CLAUDEPWN_DIR}/boxes"
ACTIVE_FILE="${CLAUDEPWN_DIR}/.claudepwn-active"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

usage() {
    cat <<EOF
${BOLD}ClaudePwn v2${NC} — Hacking Automation with Claude

${BOLD}Usage:${NC}
  claudepwn start <box-name> <ip>    Crée le workspace, configure /etc/hosts, lance claude
  claudepwn connect [ovpn-file]      Connecte le VPN HTB
  claudepwn stop                     Arrête le VPN, nettoie /etc/hosts
  claudepwn list                     Liste les boxes dans boxes/
  claudepwn help                     Affiche cette aide

${BOLD}Exemples:${NC}
  claudepwn connect lab_anthony.ovpn
  claudepwn start Sau 10.10.11.224
  claudepwn list
  claudepwn stop
EOF
}

log_info()  { echo -e "${CYAN}[*]${NC} $1"; }
log_ok()    { echo -e "${GREEN}[+]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[-]${NC} $1"; }

# ─── START ──────────────────────────────────────────────────────────────────
cmd_start() {
    if [[ $# -lt 2 ]]; then
        log_error "Usage: claudepwn start <box-name> <ip>"
        exit 1
    fi

    local box_name="${1,,}"  # lowercase
    local box_display="$1"
    local ip="$2"
    local box_dir="${BOXES_DIR}/${box_name}"

    # Valider l'IP
    if ! [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        log_error "IP invalide : $ip"
        exit 1
    fi

    # Créer le workspace
    log_info "Création du workspace pour ${BOLD}${box_display}${NC} (${ip})..."
    mkdir -p "${box_dir}"/{scans,loot,exploits}

    # Créer notes.md si pas existant
    if [[ ! -f "${box_dir}/notes.md" ]]; then
        cat > "${box_dir}/notes.md" <<NOTES
# ${box_display} — ${ip}
Date : $(date +%Y-%m-%d)

## Ports & Services
| Port | Service | Version |
|------|---------|---------|

## Web
- (aucune découverte)

## Credentials
| User | Password/Hash | Source | Accès |
|------|---------------|--------|-------|

## Vecteurs d'attaque
- (aucun identifié)

## Flags
- User :
- Root :

## Notes
NOTES
        log_ok "notes.md créé"
    else
        log_warn "notes.md existe déjà, conservation"
    fi

    # Créer log.md si pas existant
    if [[ ! -f "${box_dir}/log.md" ]]; then
        cat > "${box_dir}/log.md" <<LOG
# Log — ${box_display}

| Timestamp | Commande |
|-----------|----------|
LOG
        log_ok "log.md créé"
    fi

    # Ajouter à /etc/hosts
    local host_entry="${ip} ${box_name}.htb"
    if grep -q "${box_name}.htb" /etc/hosts 2>/dev/null; then
        log_warn "${box_name}.htb déjà dans /etc/hosts"
    else
        log_info "Ajout de ${host_entry} à /etc/hosts (sudo requis)..."
        echo "${host_entry}" | sudo tee -a /etc/hosts > /dev/null
        log_ok "Entrée /etc/hosts ajoutée"
    fi

    # Écrire le fichier actif
    cat > "${ACTIVE_FILE}" <<ACTIVE
BOX=${box_name}
BOX_DISPLAY=${box_display}
IP=${ip}
BOX_DIR=${box_dir}
ACTIVE
    log_ok "Box active : ${box_display} (${ip})"

    # Vérifier la connectivité
    log_info "Test de connectivité vers ${ip}..."
    if ping -c 1 -t 2 "$ip" > /dev/null 2>&1; then
        log_ok "Host accessible"
    else
        log_warn "Host non accessible — VPN connecté ? Essaye : claudepwn connect <fichier.ovpn>"
    fi

    # Lancer claude
    echo ""
    log_info "Lancement de Claude Code..."
    echo -e "${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    cd "${CLAUDEPWN_DIR}"
    exec claude
}

# ─── CONNECT ────────────────────────────────────────────────────────────────
cmd_connect() {
    local ovpn_file="${1:-}"

    # Chercher un .ovpn si pas spécifié
    if [[ -z "$ovpn_file" ]]; then
        ovpn_file=$(find "${CLAUDEPWN_DIR}" -maxdepth 2 -name "*.ovpn" -type f 2>/dev/null | head -1)
        if [[ -z "$ovpn_file" ]]; then
            log_error "Aucun fichier .ovpn trouvé. Usage: claudepwn connect <fichier.ovpn>"
            exit 1
        fi
        log_info "Fichier .ovpn trouvé : ${ovpn_file}"
    fi

    if [[ ! -f "$ovpn_file" ]]; then
        log_error "Fichier introuvable : $ovpn_file"
        exit 1
    fi

    # Vérifier si VPN déjà connecté
    if ifconfig utun0 > /dev/null 2>&1 || ifconfig tun0 > /dev/null 2>&1; then
        local tun_ip
        tun_ip=$(ifconfig utun0 2>/dev/null | grep -oE 'inet [0-9.]+' | awk '{print $2}' || \
                 ifconfig tun0 2>/dev/null | grep -oE 'inet [0-9.]+' | awk '{print $2}' || \
                 echo "unknown")
        log_warn "VPN déjà connecté (${tun_ip})"
        return 0
    fi

    # Lancer OpenVPN en background
    log_info "Connexion VPN..."
    sudo openvpn --config "$ovpn_file" --daemon --log /tmp/claudepwn-vpn.log

    # Attendre la connexion
    local timeout=30
    local elapsed=0
    while [[ $elapsed -lt $timeout ]]; do
        if grep -q "Initialization Sequence Completed" /tmp/claudepwn-vpn.log 2>/dev/null; then
            sleep 1
            local tun_ip
            tun_ip=$(ifconfig utun0 2>/dev/null | grep -oE 'inet [0-9.]+' | awk '{print $2}' || \
                     ifconfig tun0 2>/dev/null | grep -oE 'inet [0-9.]+' | awk '{print $2}' || \
                     echo "unknown")
            log_ok "VPN connecté — ${tun_ip}"
            return 0
        fi
        sleep 1
        ((elapsed++))
        printf "\r${CYAN}[*]${NC} Attente de la connexion... %ds" "$elapsed"
    done
    echo ""
    log_error "Timeout VPN (${timeout}s). Vérifie /tmp/claudepwn-vpn.log"
    exit 1
}

# ─── STOP ───────────────────────────────────────────────────────────────────
cmd_stop() {
    # Arrêter OpenVPN
    if pgrep -x openvpn > /dev/null 2>&1; then
        log_info "Arrêt du VPN..."
        sudo killall openvpn 2>/dev/null
        log_ok "VPN arrêté"
    else
        log_warn "Aucun VPN actif"
    fi

    # Nettoyer /etc/hosts
    if [[ -f "$ACTIVE_FILE" ]]; then
        source "$ACTIVE_FILE"
        if grep -q "${BOX}.htb" /etc/hosts 2>/dev/null; then
            log_info "Nettoyage de /etc/hosts..."
            sudo sed -i.bak "/${BOX}.htb/d" /etc/hosts
            sudo rm -f /etc/hosts.bak
            log_ok "Entrée ${BOX}.htb supprimée de /etc/hosts"
        fi
        rm -f "$ACTIVE_FILE"
        log_ok "Session nettoyée"
    else
        log_warn "Aucune session active"
    fi
}

# ─── LIST ───────────────────────────────────────────────────────────────────
cmd_list() {
    if [[ ! -d "$BOXES_DIR" ]]; then
        log_warn "Aucune box. Utilise: claudepwn start <box> <ip>"
        return 0
    fi

    local active_box=""
    if [[ -f "$ACTIVE_FILE" ]]; then
        source "$ACTIVE_FILE"
        active_box="$BOX"
    fi

    echo -e "${BOLD}Boxes :${NC}"
    echo ""
    for box_dir in "${BOXES_DIR}"/*/; do
        [[ ! -d "$box_dir" ]] && continue
        local name
        name=$(basename "$box_dir")
        local ip="?"
        local flags=""

        # Lire l'IP depuis notes.md
        if [[ -f "${box_dir}/notes.md" ]]; then
            ip=$(head -1 "${box_dir}/notes.md" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' || echo "?")

            # Vérifier les flags
            local user_flag root_flag
            user_flag=$(grep -E "^- User :" "${box_dir}/notes.md" | sed 's/- User : *//')
            root_flag=$(grep -E "^- Root :" "${box_dir}/notes.md" | sed 's/- Root : *//')
            [[ -n "$user_flag" && "$user_flag" != "" ]] && flags+="U"
            [[ -n "$root_flag" && "$root_flag" != "" ]] && flags+="R"
        fi

        local marker=""
        [[ "$name" == "$active_box" ]] && marker=" ${GREEN}← active${NC}"

        printf "  ${BOLD}%-20s${NC} %-16s %s%b\n" "$name" "$ip" "${flags:-(en cours)}" "$marker"
    done
    echo ""
}

# ─── MAIN ───────────────────────────────────────────────────────────────────
case "${1:-help}" in
    start)   shift; cmd_start "$@" ;;
    connect) shift; cmd_connect "$@" ;;
    stop)    cmd_stop ;;
    list)    cmd_list ;;
    help|*)  usage ;;
esac
