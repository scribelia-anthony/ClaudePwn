#!/usr/bin/env python3
"""Parse ffuf JSON output into clean, readable results."""
import json
import sys

def parse(path):
    try:
        with open(path) as f:
            data = json.load(f)
    except json.JSONDecodeError as e:
        print(f"Erreur: JSON invalide dans {path}: {e}")
        return
    except FileNotFoundError:
        print(f"Erreur: fichier introuvable: {path}")
        return

    if not isinstance(data, dict):
        print(f"Erreur: format inattendu (attendu objet JSON, reçu {type(data).__name__})")
        return

    results = data.get("results", [])
    if not isinstance(results, list) or not results:
        print("Aucun résultat.")
        return

    # Group by status code
    by_status = {}
    for r in results:
        if not isinstance(r, dict):
            continue
        fuzz = r.get("input", {}).get("FUZZ", "")
        if not fuzz or fuzz.startswith("#"):
            continue
        status = r.get("status", 0)
        by_status.setdefault(status, []).append(r)

    if not by_status:
        print("Aucun résultat.")
        return

    for status in sorted(by_status):
        entries = sorted(by_status[status], key=lambda r: r.get("length", 0))
        for r in entries:
            length = r.get("length", 0)
            url = r.get("url", "")
            words = r.get("words", 0)
            print(f"[{status}] {length:>6}b {words:>4}w  {url}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: ffuf-parse <fichier.json>")
        sys.exit(1)
    parse(sys.argv[1])
